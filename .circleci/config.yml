version: 2.1
jobs:
  build_docker:
    machine: true

    steps:
      - checkout
      - run: docker build -t petersonryan/website:$CIRCLE_SHA1 .
      - run: docker login -u petersonryan -p $DOCKERHUB_ACCESS_KEY
      - run: docker push petersonryan/website:$CIRCLE_SHA1

  deploy:
    machine: true

    steps:
      - add_ssh_keys:
          fingerprints:
            - "dc:02:a1:3e:46:b5:34:99:54:c2:1e:1e:b1:c4:78:95"
            
      - run: ssh-keyscan petersonryan.com
      - run: ssh deploy@petersonryan.com -v "sh /home/deploy/scripts/website.sh $CIRCLE_SHA1"

workflows:
  buildDocker:
    jobs:
      - build_docker
      - deploy:
          requires:
            - build_docker
          filters:
            branches:
              only:
                - master
